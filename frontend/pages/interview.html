<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Peer-to-Peer Interview - Interview Helper</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <script>
      const isLoggedIn = "{{ 'true' if is_logged_in else 'false' }}";
    </script>
    <script src="../assets/js/navbar.js"></script>
  </head>
  <body
    class="bg-gray-50 text-black dark:text-white dark:bg-gray-900 transition-all duration-300 min-h-screen"
  >
    <div
      class="pt-32 flex flex-col items-center justify-center max-w-3xl mx-auto px-4 py-8"
    >
      <h1 class="text-3xl font-bold mb-8 text-center gradient-text">
        Peer-to-Peer Interview
      </h1>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="glassmorphism rounded-2xl p-6 shadow-2xl">
          <video
            id="localVideo"
            autoplay
            class="w-full rounded-xl mb-4"
          ></video>
          <video id="remoteVideo" autoplay class="w-full rounded-xl"></video>
        </div>
        <div class="flex flex-col justify-center items-center">
          <button
            id="startCall"
            class="px-8 py-4 rounded-xl bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold hover:scale-105 transition-transform"
          >
            Start Call
          </button>
        </div>
      </div>
    </div>

    <script>
      const socket = io();
      let localStream, peerConnection;
      const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

      document
        .getElementById("startCall")
        .addEventListener("click", async () => {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });
          document.getElementById("localVideo").srcObject = localStream;

          peerConnection = new RTCPeerConnection(config);
          localStream
            .getTracks()
            .forEach((track) => peerConnection.addTrack(track, localStream));

          peerConnection.onicecandidate = (e) => {
            if (e.candidate) socket.emit("candidate", e.candidate);
          };

          peerConnection.ontrack = (e) => {
            document.getElementById("remoteVideo").srcObject = e.streams[0];
          };

          const offer = await peerConnection.createOffer();
          await peerConnection.setLocalDescription(offer);
          socket.emit("offer", offer);
        });

      socket.on("offer", async (offer) => {
        peerConnection = new RTCPeerConnection(config);
        localStream
          .getTracks()
          .forEach((track) => peerConnection.addTrack(track, localStream));
        peerConnection.onicecandidate = (e) =>
          socket.emit("candidate", e.candidate);
        peerConnection.ontrack = (e) =>
          (document.getElementById("remoteVideo").srcObject = e.streams[0]);

        await peerConnection.setRemoteDescription(
          new RTCSessionDescription(offer)
        );
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit("answer", answer);
      });

      socket.on("answer", (answer) =>
        peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
      );
      socket.on("candidate", (candidate) =>
        peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
      );
    </script>
  </body>
</html>
